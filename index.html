<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>Single Crowd Simulator</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" type="text/css" href="./three.css">
</head>

<body>

  <script src="./lib/axios.js"></script> <!-- Promise-based AJAX library-->
  <script src="./lib/lodash.js"></script> <!-- Standard JS Utility Library-->

  <!-- <script src="https://cdn.jsdelivr.net/npm/@ricksteam/fluent-behavior-tree-browser@0.2.0/bundle.js"></script> -->
  <script src="./crowd-setup/bundle.js"></script>

  <script src="./worker.js"></script> <!-- Our port of RecastDetour-->
  
  <script src="//mrdoob.github.io/stats.js/build/stats.min.js"></script>

  <script type="module">
    
    import MedicalAgent from "./people/medical-agent.js"
    import PatientAgent from "./people/patient-agent.js"
    import CrowdSetup from "./crowd-setup/index.js"
    import urlParser from "./url-parser.js"
    import colorFunction from "./color-function.js"
    import simulations from "./simulations.js"
    import HospitalClass from "./support/hospital.js"
    import Computer from "./support/Computer.js"
    import Room from "./support/room.js"
    import Vector3 from "./math/vector-3.js"

    import index from "./crowd-setup/index.js"

    let params = {};

    //Change to the cdn in production
    let assetBase = "./";
    //let assetBase = "https://cdn.jsdelivr.net/npm/@crowdedjs/assets/";

    //Flat hospital removes the walls to speed up debugging
    //params.objPath = assetBase + "objs/hospital-flat.obj";
     params.objPath = assetBase + "objs/hospital.obj";

    //
    params.arrivalPath = assetBase + "arrivals/arrivalHospital.json";
    //params.arrivalPath = "./" + "arrivals/arrivalHospital.json";

    params.locationsPath = "./" + "locations/locationsHospital.json";

    //This does not represent seconds any more
    params.secondsOfSimulation = 300;
    params.millisecondsBetweenFrames = 40;
    

    params = urlParser(window, params, assetBase);

    //Set these up as global variables
    window.Hospital = HospitalClass;
    window.Vector3 = Vector3;

    //Grab the information about our simulaiton
    let promises = [axios.get(params.objPath), axios.get(params.locationsPath), axios.get(params.arrivalPath)];
    Promise.all(promises)
      .then(results => {
        let objValue = results[0].data;       //Grab the value of the environment 
        let locationValue = JSON.parse(results[1].data);  //Grab the value of all the locations
        let arrivalValue = JSON.parse(results[2].data);   //Grab the value of all the arrivals

        let agentConstants = [];  //An array with all the high-level agent information (not the simulation data)
        let locations = [];

        //Remove spaces in annotation names
        locationValue.forEach(l => {
          locations.push(new Room(l.position, l.annotationName.toUpperCase().replace(" ", "_"), l.name))
        })

        //Assign the data to the global hospital object
        Hospital.agents = agentConstants;
        Hospital.locations = locations;
        Hospital.computer = new Computer();

        //Add an agent with a behavior and an id
        arrivalValue.forEach((agent, index) => {
          if (agent.name == "patient")
            agentConstants.push(new PatientAgent(agent, locationValue));
          else
            agentConstants.push(new MedicalAgent(agent, locationValue));
          //Is this line necessary?
          agentConstants[agentConstants.length - 1].setId(index);
        })        

        // Start the simulation.
        let crowdSetup = new CrowdSetup(objValue, agentConstants, params.secondsOfSimulation, params.millisecondsBetweenFrames, locationValue, window, document.body, colorFunction, simulations, "./crowd-setup/");
        //

        //x: MIN -70 MAX 62 = 132
        //z: MIN -43 MAX 74 = 117
        // each grid square should be 13.2 x and 11.7 z
        
        // create button, if button is clicked, it will show and calculate heat map
        // display 10x10 table, each cell will have a certain color
        // green for never visited, red for a lot of activity

        // check every frame, figure out which grid square agents are in
        // calculate agents per frame in each grid square

        window.heatMap = ()=>{
          // HEAT MAP
          // Create a 10x10 grid
          var gridArray = new Array(10);
          var column1 = []; (column1 = []).length = 10; column1.fill(0);
          var column2 = []; (column2 = []).length = 10; column2.fill(0);
          var column3 = []; (column3 = []).length = 10; column3.fill(0);
          var column4 = []; (column4 = []).length = 10; column4.fill(0);
          var column5 = []; (column5 = []).length = 10; column5.fill(0);
          var column6 = []; (column6 = []).length = 10; column6.fill(0);
          var column7 = []; (column7 = []).length = 10; column7.fill(0);
          var column8 = []; (column8 = []).length = 10; column8.fill(0);
          var column9 = []; (column9 = []).length = 10; column9.fill(0);
          var column10 = []; (column10 = []).length = 10; column10.fill(0);

          gridArray[0] = column1;
          gridArray[1] = column2;
          gridArray[2] = column3;
          gridArray[3] = column4;
          gridArray[4] = column5;
          gridArray[5] = column6;
          gridArray[6] = column7;
          gridArray[7] = column8;
          gridArray[8] = column9;
          gridArray[9] = column10;

          let currentFrame = crowdSetup.agentPositions.length;

          let xSegVal = 13.2;
          let zSegVal = 11.7;

          let xStartVal = -70;
          let zStartVal = -43;

          for (let i = 0; i < currentFrame; i++)
          {
            crowdSetup.agentPositions[i].forEach(agent => {
                let xSection = Math.floor((agent.x - xStartVal) / xSegVal);
                let zSection = Math.floor((agent.z - zStartVal) / zSegVal);
                gridArray[xSection][zSection]++;
            })
          }

          for (let i = 0; i < gridArray.length; i++)
          {
            for (let j = 0; j < gridArray[i].length; j++)
            {
              gridArray[i][j] = gridArray[i][j] / currentFrame;
              
              // TABLE FOR HEAT MAP GRID
              var heatMapTable = document.getElementById("HeatMapTable");
              //titleCell.innerHTML = "Computer Entry";
              
              for (let k = 0; k < 10; k++)
              {
                var heatMapRow = heatMapTable.insertRow(k);
                for (let l = 0; l < 10; l++)
                {
                  var heatMapCell = heatMapRow.insertCell(l);
                }
              }

              console.log("Row: " + (i + 1) + ", Column: " + (j + 1) + "; " + gridArray[i][j] + " agents/frame");
            }
          }
        }

        // TABLE OF COMPUTER ENTRIES - can add new columns as needed
        var table = document.getElementById("ComputerEntryTable");
        // title row
        var titleRow = table.insertRow(0);
        var titleCell = titleRow.insertCell(0);
        var chiefComplaintCell = titleRow.insertCell(1);
        var takenVitalsCell = titleRow.insertCell(2); 
        titleCell.innerHTML = "Computer Entry";
        chiefComplaintCell.innerHTML = "Chief Complaint";
        takenVitalsCell.innerHTML = "Vitals Taken";
        
        let computerEntries = 0;
        
        function fillComputerTable() {
          for(let i = 0; i < Hospital.computer.entries.length; i++)
          {
            // add missing entries to table
            if (Hospital.computer.entries.length > computerEntries)
            {
              var tempRow = table.insertRow(computerEntries + 1)
              var cell1 = tempRow.insertCell(0);
              var cell2 = tempRow.insertCell(1);
              var cell3 = tempRow.insertCell(2);
              cell1.innerHTML = computerEntries + 1;
              cell2.innerHTML = Hospital.computer.entries[computerEntries].getChiefComplaint();
              cell3.innerHTML = Hospital.computer.entries[computerEntries].getVitals();

              computerEntries++;

              // var tempRow1 = table.insertRow(2)
              // var cell1 = tempRow1.insertCell(0);
              // var cell2 = tempRow1.insertCell(1);
              // var cell3 = tempRow1.insertCell(2);
              // cell1.innerHTML = "temp";
              // cell2.innerHTML = "sample text";
              // cell3.innerHTML = "more sample text";
              

              // var tempRow2 = table.insertRow(3)
              // var cell1 = tempRow2.insertCell(0);
              // var cell2 = tempRow2.insertCell(1);
              // var cell3 = tempRow2.insertCell(2);
              // cell1.innerHTML = "temp";
              // cell2.innerHTML = "sample text";
              // cell3.innerHTML = "more sample text";

              // var tempRow3 = table.insertRow(4)
              // var cell1 = tempRow3.insertCell(0);
              // var cell2 = tempRow3.insertCell(1);
              // var cell3 = tempRow3.insertCell(2);
              // cell1.innerHTML = "temp";
              // cell2.innerHTML = "sample text";
              // cell3.innerHTML = "more sample text";
            }

            //update existing entries in table
            document.getElementById("ComputerEntryTable").rows[i + 1].cells[1].innerHTML = Hospital.computer.entries[i].getChiefComplaint();
            document.getElementById("ComputerEntryTable").rows[i + 1].cells[2].innerHTML = Hospital.computer.entries[i].getVitals();
          }
          requestAnimationFrame( fillComputerTable );
        }

        fillComputerTable();

        //Show FPS Counter
        // SCORING FUNCTION GRAPH
        //javascript: (function () { var script = document.createElement('script'); script.onload = function () { var stats = new Stats(); document.body.appendChild(stats.dom); requestAnimationFrame(function loop() { stats.update(); requestAnimationFrame(loop) }); }; script.src = '//mrdoob.github.io/stats.js/build/stats.min.js'; document.head.appendChild(script); })()
        var stats = new Stats();
        //AGENTS IN SIMULATION PER FRAME
        var xPanel = stats.addPanel( new Stats.Panel( 'AGENTS', '#ff8', '#221' ) );
        stats.showPanel(2);
        stats.dom.style.position = 'fixed';
        stats.dom.style.float = 'left';
        document.body.appendChild( stats.dom );
        let i = 0;

        // animates a graph that displays the agents in the simulation each frame
        function animate() {
          if (typeof crowdSetup.agentPositions[i] === 'undefined')
          {
            //console.log("undefined");
          }
          else
          {
            let agentsIn = 0;
            for (let j = 0; j < crowdSetup.agentPositions[i].length; j++)
            {
              if (crowdSetup.agentPositions[i][j].inSimulation)
              {
                agentsIn++;
              }
            }
            //xPanel.update(crowdSetup.agentPositions[i].length);
            xPanel.update(agentsIn);
            i++;
          }
    
          stats.update();

          requestAnimationFrame( animate );

        }

        animate();

      })
      //This can be commented out for debugging purposes. In production, this should not be commented.
      // .catch(error => {
      //   console.log("Error in the app " + error)
      // })
  </script>
  
  <div class="HeatMap">
    <style>
      table#heatMapTable {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        position: absolute;
        bottom: 50%;
        right: 50%;
        height: 500px;
        width: 500px;
        z-index: 99;
        display: block;
        table-layout:fixed;
        overflow:auto;
      }
      
      /* td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
      } */
    </style>
    
    <style>
        button#heatMap {
        position: absolute;
        bottom: 50%;
        left: 1%;
        background-color: Gray;
        border: none;
        color: black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        z-index: 99;
        display: inline-block;
        font-size: 16px;
      }
    </style> 

    <table id = "HeatMapTable"></table> 
    
    <button id="heatMap" type="button" onclick="heatMap()">Heat Map</button>

  </div>

  <div class="ComputerEntries">
    <style>
      table#ComputerEntryTable {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        position: absolute;
        bottom: 1%;
        right: 1%;
        height: 200px;
        width: 250px;
        z-index: 99;
        display: block;
        table-layout:fixed;
        overflow:auto;
      }
      
      td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
      }
      
      tr:nth-child(even) {
        background-color: #dddddd;
      }
      tr:nth-child(odd) {
        background-color: #738276;
      }
    </style>

    <table id = "ComputerEntryTable"></table> 
     
    <button id="btn" type="button" onclick="hideTable()">Hide/View Table</button>

    <style>
      button#btn {
        position: absolute;
        bottom: 25%;
        left: 1%;
        background-color: Gray;
        border: none;
        color: black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        z-index: 99;
        display: inline-block;
        font-size: 16px;
      }
    </style> 

    <script>
        function hideTable() {
          var x = document.getElementById("ComputerEntryTable");
          if (x.style.display === "none") {
            x.style.display = "block";
          } else {
            x.style.display = "none";
          }
        }
    </script>

  </div>

</body>

</html>